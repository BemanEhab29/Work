<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Hours Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    table, th, td { border: 1px solid black; text-align: center; padding: 8px; }
    input, button { margin: 5px; }
    .holiday { background-color: #ffe0e0; font-weight: bold; }
    .friday { background-color: #e0f7ff; font-weight: bold; }
    .delete-btn { background: red; color: white; border: none; padding: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Work Hours Tracker</h2>
  
  <label>Date: <input type="date" id="date"></label>
  <label>Start: <input type="time" id="start"></label>
  <label>End: <input type="time" id="end"></label>
  <label>Hourly Rate: <input type="number" id="rate" value="10"></label>
  <label><input type="checkbox" id="holiday"> National Holiday</label>
  <label><input type="checkbox" id="friday"> Friday</label>
  <label><input type="checkbox" id="permission"> Late with Permission</label>
  <button onclick="addEntry()">Add Entry</button>
  <button onclick="exportExcel()">Export to Excel</button>
  <input type="file" id="importFile" accept=".xlsx" onchange="importExcel(event)">
  
  <table id="workTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Worked Hours</th>
        <th>Regular Hours</th>
        <th>Overtime Hours</th>
        <th>Saturday Hours</th>
        <th>Deductions</th>
        <th>Total Money</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr id="totalsRow">
        <td>Total</td>
        <td id="totalWorked">0</td>
        <td id="totalRegular">0</td>
        <td id="totalOvertime">0</td>
        <td id="totalSaturday">0</td>
        <td id="totalDeduction">0</td>
        <td id="totalMoney">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
  
  <script>
    let entries = JSON.parse(localStorage.getItem("workEntries")) || [];

    function saveData() {
      localStorage.setItem("workEntries", JSON.stringify(entries));
    }

    function formatDate(d) {
      const date = new Date(d);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function calculateRow(entry) {
      let { date, start, end, rate, holiday, friday, permission } = entry;
      let worked = 0, regular = 0, overtime = 0, saturday = 0, deduction = 0, money = 0;
      let d = new Date(date);
      let day = d.getDay(); // 0=Sun, 5=Fri, 6=Sat

      if (friday) {
        return { worked: 0, regular: 0, overtime: 0, saturday: 0, deduction: 0, money: 0, isFriday: true };
      }

      if (holiday) {
        worked = 8;
        regular = 8;
        money = 8 * rate;
        return { worked, regular, overtime, saturday, deduction, money, isHoliday: true };
      }

      let startTime = new Date("1970-01-01T" + start);
      let endTime = new Date("1970-01-01T" + end);

      let startHours = startTime.getHours() + startTime.getMinutes() / 60;
      let endHours = endTime.getHours() + endTime.getMinutes() / 60;

      if (endHours < startHours) {
        // next day case
        worked = (24 - startHours) + endHours;
      } else {
        worked = endHours - startHours;
      }

      if (day === 6) saturday = worked;
      regular = Math.min(8, worked);
      overtime = worked > 8 ? worked - 8 : 0;

      // Late deductions (only if not permitted)
      let late = startHours;
      if (!permission && late > 9) {
        if (late <= 9.25) deduction = -1;
        else if (late <= 9.5) deduction = -2;
        else if (late <= 10) deduction = -4;
        else deduction = -8;
      }

      if (day === 6) {
        // Saturday = double rate
        money = worked * 2 * rate + deduction * rate;
      } else {
        money = (regular * rate) + (overtime * 1.5 * rate) + (deduction * rate);
      }

      return { worked, regular, overtime, saturday, deduction, money };
    }

    function renderTable() {
      let tbody = document.querySelector("#workTable tbody");
      tbody.innerHTML = "";
      let totals = { worked: 0, regular: 0, overtime: 0, saturday: 0, deduction: 0, money: 0 };

      entries.forEach((entry, index) => {
        let row = calculateRow(entry);
        let tr = document.createElement("tr");

        if (row.isFriday) {
          tr.className = "friday";
          tr.innerHTML = `<td>${formatDate(entry.date)}</td><td colspan="6">Friday</td>
            <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>`;
        } else if (row.isHoliday) {
          tr.className = "holiday";
          tr.innerHTML = `<td>${formatDate(entry.date)}</td>
            <td>${row.worked}</td><td>${row.regular}</td><td>${row.overtime}</td>
            <td>${row.saturday}</td><td>${row.deduction}</td><td>${row.money.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>`;
        } else {
          tr.innerHTML = `<td>${formatDate(entry.date)}</td>
            <td>${row.worked.toFixed(2)}</td><td>${row.regular.toFixed(2)}</td><td>${row.overtime.toFixed(2)}</td>
            <td>${row.saturday.toFixed(2)}</td><td>${row.deduction}</td><td>${row.money.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>`;
        }

        tbody.appendChild(tr);
        totals.worked += row.worked;
        totals.regular += row.regular;
        totals.overtime += row.overtime;
        totals.saturday += row.saturday;
        totals.deduction += row.deduction;
        totals.money += row.money;
      });

      document.getElementById("totalWorked").textContent = totals.worked.toFixed(2);
      document.getElementById("totalRegular").textContent = totals.regular.toFixed(2);
      document.getElementById("totalOvertime").textContent = totals.overtime.toFixed(2);
      document.getElementById("totalSaturday").textContent = totals.saturday.toFixed(2);
      document.getElementById("totalDeduction").textContent = totals.deduction.toFixed(2);
      document.getElementById("totalMoney").textContent = totals.money.toFixed(2);

      saveData();
    }

    function addEntry() {
      let date = document.getElementById("date").value;
      let start = document.getElementById("start").value;
      let end = document.getElementById("end").value;
      let rate = parseFloat(document.getElementById("rate").value);
      let holiday = document.getElementById("holiday").checked;
      let friday = document.getElementById("friday").checked;
      let permission = document.getElementById("permission").checked;

      if (!date) return alert("Enter date");
      entries.push({ date, start, end, rate, holiday, friday, permission });
      renderTable();
    }

    function deleteEntry(index) {
      entries.splice(index, 1);
      renderTable();
    }

    function exportExcel() {
      // Add totals as a new row before export
      let totalRow = {
        date: "TOTALS",
        start: "",
        end: "",
        rate: "",
        holiday: "",
        friday: "",
        permission: "",
        worked: document.getElementById("totalWorked").textContent,
        regular: document.getElementById("totalRegular").textContent,
        overtime: document.getElementById("totalOvertime").textContent,
        saturday: document.getElementById("totalSaturday").textContent,
        deduction: document.getElementById("totalDeduction").textContent,
        totalMoney: document.getElementById("totalMoney").textContent
      };

      let exportData = [...entries, totalRow];
      let worksheet = XLSX.utils.json_to_sheet(exportData);
      let workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "WorkData");
      XLSX.writeFile(workbook, "WorkData.xlsx");
    }

    function importExcel(event) {
      let file = event.target.files[0];
      let reader = new FileReader();
      reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, { type: 'array' });
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        entries = XLSX.utils.sheet_to_json(sheet).filter(r => r.date && r.date !== "TOTALS");
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    }

    renderTable();
  </script>
</body>
</html>
