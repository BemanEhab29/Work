<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Hours Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; text-align: center; padding: 8px; }
    th { background: #efefef; }
    input, button, label { margin: 5px; }
    .holiday { background-color: #ffe0e0; font-weight: bold; }
    .friday { background-color: #e0f7ff; font-weight: bold; }
    .delete-btn { background: red; color: white; border: none; padding: 5px; cursor: pointer; border-radius: 5px; }
    .controls { margin-bottom: 10px; }
    .checkboxes { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Work Hours Tracker</h2>

  <div class="controls">
    <label>Date: <input type="date" id="date"></label>
    <label>Start (24h): <input type="time" id="start"></label>
    <label>End (24h): <input type="time" id="end"></label>
    <label>Hourly Rate: <input type="number" id="rate" value="10"></label>
  </div>

  <div class="checkboxes">
    <label><input type="checkbox" id="holiday"> National Holiday</label>
    <label><input type="checkbox" id="friday"> Friday</label>
    <label><input type="checkbox" id="permission"> Late with Permission</label>
  </div>

  <div>
    <button onclick="addEntry()">Add Entry</button>
    <button onclick="exportExcel()">Export to Excel</button>
    <input type="file" id="importFile" accept=".xlsx" onchange="importExcel(event)">
  </div>

  <table id="workTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Worked Hours</th>
        <th>Regular Hours</th>
        <th>Overtime Hours</th>
        <th>Saturday Hours</th>
        <th>Deductions</th>
        <th>Total Money</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr id="totalsRow">
        <td>Total</td>
        <td id="totalWorked">0</td>
        <td id="totalRegular">0</td>
        <td id="totalOvertime">0</td>
        <td id="totalSaturday">0</td>
        <td id="totalDeduction">0</td>
        <td id="totalMoney">0</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <script>
    let entries = JSON.parse(localStorage.getItem("workEntries")) || [];

    function saveData() {
      localStorage.setItem("workEntries", JSON.stringify(entries));
    }

    function formatDate(d) {
      const date = new Date(d);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function calculateRow(entry) {
      let { date, start, end, rate, holiday, friday, permission } = entry;
      let worked = 0, regular = 0, overtime = 0, saturday = 0, deduction = 0, money = 0;

      const d = new Date(date);
      const day = d.getDay(); // 0=Sun, 5=Fri, 6=Sat

      if (friday) {
        return { worked: 0, regular: 0, overtime: 0, saturday: 0, deduction: 0, money: 0, isFriday: true };
      }

      if (holiday) {
        worked = 8;
        regular = 8;
        money = 8 * rate;
        return { worked, regular, overtime, saturday, deduction, money, isHoliday: true };
      }

      const startTime = new Date("1970-01-01T" + start);
      const endTime = new Date("1970-01-01T" + end);

      // Handle next-day shift
      let hoursWorked;
      if (endTime < startTime) {
        const untilMidnight = (24 - (startTime.getHours() + startTime.getMinutes() / 60));
        const afterMidnight = (endTime.getHours() + endTime.getMinutes() / 60);
        hoursWorked = untilMidnight + afterMidnight;
      } else {
        hoursWorked = (endTime - startTime) / 36e5;
      }

      worked = hoursWorked;
      if (day === 6) saturday = worked;

      // Regular + overtime split
      regular = Math.min(8, worked);
      overtime = worked > 8 ? worked - 8 : 0;

      // Late deduction
      const late = startTime.getHours() + startTime.getMinutes() / 60;
      if (!permission && late > 9) {
        if (late <= 9.25) deduction = -1;
        else if (late <= 9.5) deduction = -2;
        else if (late <= 10) deduction = -4;
        else deduction = -8;
      }

      // Calculate total money
      if (day === 6) {
        money = (worked * 2 * rate) + (deduction * rate);
      } else {
        money = (regular * rate) + (overtime * 1.5 * rate) + (deduction * rate);
      }

      return { worked, regular, overtime, saturday, deduction, money };
    }

    function renderTable() {
      const tbody = document.querySelector("#workTable tbody");
      tbody.innerHTML = "";
      const totals = { worked: 0, regular: 0, overtime: 0, saturday: 0, deduction: 0, money: 0 };

      entries.forEach((entry, index) => {
        const row = calculateRow(entry);
        const tr = document.createElement("tr");

        if (row.isFriday) {
          tr.className = "friday";
          tr.innerHTML = `<td>${formatDate(entry.date)}</td><td colspan="6">Friday</td>
            <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>`;
        } else if (row.isHoliday) {
          tr.className = "holiday";
          tr.innerHTML = `<td>${formatDate(entry.date)}</td>
            <td>${row.worked}</td><td>${row.regular}</td><td>${row.overtime}</td>
            <td>${row.saturday}</td><td>${row.deduction}</td><td>${row.money.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>`;
        } else {
          tr.innerHTML = `<td>${formatDate(entry.date)}</td>
            <td>${row.worked.toFixed(2)}</td><td>${row.regular.toFixed(2)}</td><td>${row.overtime.toFixed(2)}</td>
            <td>${row.saturday.toFixed(2)}</td><td>${row.deduction}</td><td>${row.money.toFixed(2)}</td>
            <td><button class="delete-btn" onclick="deleteEntry(${index})">Delete</button></td>`;
        }

        tbody.appendChild(tr);

        totals.worked += row.worked;
        totals.regular += row.regular;
        totals.overtime += row.overtime;
        totals.saturday += row.saturday;
        totals.deduction += row.deduction;
        totals.money += row.money;
      });

      document.getElementById("totalWorked").textContent = totals.worked.toFixed(2);
      document.getElementById("totalRegular").textContent = totals.regular.toFixed(2);
      document.getElementById("totalOvertime").textContent = totals.overtime.toFixed(2);
      document.getElementById("totalSaturday").textContent = totals.saturday.toFixed(2);
      document.getElementById("totalDeduction").textContent = totals.deduction.toFixed(2);
      document.getElementById("totalMoney").textContent = totals.money.toFixed(2);

      saveData();
    }

    function addEntry() {
      const date = document.getElementById("date").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const rate = parseFloat(document.getElementById("rate").value);
      const holiday = document.getElementById("holiday").checked;
      const friday = document.getElementById("friday").checked;
      const permission = document.getElementById("permission").checked;

      if (!date) return alert("Enter date");

      entries.push({ date, start, end, rate, holiday, friday, permission });
      renderTable();
    }

    function deleteEntry(index) {
      entries.splice(index, 1);
      renderTable();
    }

    function exportExcel() {
      const tableData = entries.map(e => ({
        Date: formatDate(e.date),
        ...calculateRow(e)
      }));
      const totals = {
        Date: "TOTAL",
        worked: document.getElementById("totalWorked").textContent,
        regular: document.getElementById("totalRegular").textContent,
        overtime: document.getElementById("totalOvertime").textContent,
        saturday: document.getElementById("totalSaturday").textContent,
        deduction: document.getElementById("totalDeduction").textContent,
        money: document.getElementById("totalMoney").textContent
      };
      tableData.push(totals);

      const worksheet = XLSX.utils.json_to_sheet(tableData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "WorkData");
      XLSX.writeFile(workbook, "WorkData.xlsx");
    }

    function importExcel(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const imported = XLSX.utils.sheet_to_json(sheet);
        entries = imported.filter(r => r.Date && r.Date !== "TOTAL").map(r => ({
          date: r.Date.split("/").reverse().join("-"),
          start: r.start || "09:00",
          end: r.end || "17:00",
          rate: parseFloat(r.rate) || 10,
          holiday: false,
          friday: false,
          permission: false
        }));
        renderTable();
      };
      reader.readAsArrayBuffer(file);
    }

    renderTable();
  </script>
</body>
</html>
